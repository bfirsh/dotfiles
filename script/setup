#!/bin/zsh
set -e

DOTFILES_DIR="$(cd "$(dirname "$0")/.." && pwd)"

#if [ ! -f ~/.ssh/id_rsa ]; then
#  echo "Put your SSH key in ~/.ssh"
#  exit 1
#fi

# Create symlinks from dotfiles to home directory
echo "Creating symlinks..."

# List of files/directories to exclude from symlinking
EXCLUDE=(
  "README.md"
  ".claude"
  ".git"
  ".gitignore"
  ".gitmodules"
  "script"
)

# Directories that should be symlinked as a whole (not recursed into)
SYMLINK_DIR=(
  ".config/karabiner"
)

# Function to check if an item is in the exclude list
is_excluded() {
  local item="$1"
  for exclude in "${EXCLUDE[@]}"; do
    if [[ "$item" == "$exclude" ]]; then
      return 0
    fi
  done
  return 1
}

# Function to check if a path should be symlinked as a whole directory
should_symlink_dir() {
  local rel_path="$1"
  for dir in "${SYMLINK_DIR[@]}"; do
    if [[ "$rel_path" == "$dir" ]]; then
      return 0
    fi
  done
  return 1
}

# Function to recursively create symlinks
create_symlinks() {
  local source_dir="$1"
  local target_dir="$2"
  local rel_prefix="${3:-}"

  # Process all items (files and directories) using Zsh glob qualifiers
  # (D) includes hidden files/dirs (dotfiles)
  # (N) sets nullglob (empty list if no matches)
  for item in "$source_dir"/*(DN) "$source_dir"/.(DN); do
    local base_name=$(basename "$item")

    # Skip . and .. directories
    if [[ "$base_name" == "." || "$base_name" == ".." ]]; then
      continue
    fi

    # Skip excluded items
    if is_excluded "$base_name"; then
      continue
    fi

    local target_path="$target_dir/$base_name"
    local source_path="${item}"
    local item_rel_path="${rel_prefix:+$rel_prefix/}$base_name"

    if [[ -d "$item" ]] && ! should_symlink_dir "$item_rel_path"; then
      # Recurse into directory
      mkdir -p "$target_path"
      create_symlinks "$source_path" "$target_path" "$item_rel_path"
    else
      # Symlink file or whole directory
      if [[ -e "$target_path" && ! -L "$target_path" ]]; then
        echo "Backing up existing: $target_path"
        mv "$target_path" "$target_path.backup"
      fi

      if [[ ! -L "$target_path" ]]; then
        echo "Linking $target_path"
        ln -sf "$source_path" "$target_path"
      fi
    fi
  done
}

# Start creating symlinks from the dotfiles directory to home
create_symlinks "$DOTFILES_DIR" "$HOME"

echo "Installing/updating vim plugins..."
vim +PlugInstall +PlugUpdate +qall

if (( ! $+commands[brew] )); then
  echo "Installing homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi
eval "$(/opt/homebrew/bin/brew shellenv)"

echo "Purchasing apps..."
# Ensure mas is installed
#if ! command -v mas &> /dev/null; then
#    echo "Installing mas..."
#    brew install mas
#fi

# Extract mas app IDs from Brewfile
#MAS_APPS=$(grep 'mas "' .Brewfile | awk -F'id: ' '{print $2}' | tr -d ',')

# Get the list of installed Mac App Store apps once
#INSTALLED_APPS=$(mas list | awk '{print $1}')

# Loop through each app ID
#echo "$MAS_APPS" | while read -r APP_ID; do
#    # Remove any whitespace issues
#    APP_ID=$(echo "$APP_ID" | tr -d '[:space:]')
#
#    if echo "$INSTALLED_APPS" | grep -q "^$APP_ID$"; then
#        echo "App with ID: $APP_ID is already owned."
#    else
#        echo "Purchasing app with ID: $APP_ID"
#        mas purchase "$APP_ID"
#    fi
#done

echo "Installing brew packages..."
brew update
brew bundle install --global --no-upgrade

echo "Setting macOS settings..."
defaults write -g KeyRepeat -int 2
defaults write -g InitialKeyRepeat -int 15
defaults write -g ApplePressAndHoldEnabled -bool false
defaults write NSGlobalDomain AppleICUForce24HourTime -bool true
defaults write NSGlobalDomain AppleTemperatureUnit -string "Celsius"
defaults write NSGlobalDomain AppleMeasurementUnits -string "Centimeters"
defaults write NSGlobalDomain AppleMetricUnits -bool true
defaults write NSGlobalDomain AppleICUDateFormatStrings -dict-add 1 "yyyy-MM-dd"
defaults write NSGlobalDomain AppleICUDateFormatStrings -dict-add 2 "yyyy-MM-dd"
defaults write NSGlobalDomain AppleICUDateFormatStrings -dict-add 3 "yyyy-MM-dd"
defaults write NSGlobalDomain AppleICUDateFormatStrings -dict-add 4 "yyyy-MM-dd"
# disable keyboard backlight
sudo defaults write /Library/Preferences/com.apple.iokit.AmbientLightSensor "Keyboard Dim" -bool false
sudo defaults write /Library/Preferences/com.apple.iokit.AmbientLightSensor "Keyboard Backlight" -int 0
# night shift
defaults write com.apple.CoreBrightness CBBlueLightReductionCCTTarget -int 6500
defaults write com.apple.CoreBrightness CBBlueLightReductionScheduleEnabled -bool true
# prefer column view
defaults write com.apple.finder FXPreferredViewStyle clmv

# keyboard shortcuts for switching spaces: ctrl-h (left), ctrl-l (right)
# FIXME: doesn't work
defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 79 '{ enabled = true; value = { parameters = ( 104, 4, 262144 ); type = standard; }; }'
defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 81 '{ enabled = true; value = { parameters = ( 108, 37, 262144 ); type = standard; }; }'

# speed up space switching animation
# FIXME: doesn't work
defaults write com.apple.dock expose-animation-duration -float 0.1
defaults write com.apple.dock workspaces-swoosh-animation-off -bool true

# screenshots
mkdir -p ~/Documents/Screenshots
defaults write com.apple.screencapture location ~/Documents/Screenshots
dockutil --add ~/Documents/Screenshots --view fan --sort dateadded --display stack --no-restart  --replacing "Screenshots"

# menu bar
defaults write com.apple.controlcenter "NSStatusItem Visible NowPlaying" -bool false

defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

# Night shift
nightlight temp 100
nightlight schedule start

# Install ghostty terminfo to root user so sudo works
# https://github.com/ghostty-org/ghostty/discussions/4273
infocmp -x | sudo tic -x -


killall ControlCenter
killall Dock
killall SystemUIServer

# reload keyboard shortcuts
/System/Library/PrivateFrameworks/SystemAdministration.framework/Resources/activateSettings -u
